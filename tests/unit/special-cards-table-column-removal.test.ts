/**
 * @jest-environment jsdom
 */

describe('Special Cards Table Column Removal', () => {
  let mockDocument: any;

  beforeEach(() => {
    // Mock DOM elements
    mockDocument = {
      getElementById: jest.fn(),
      createElement: jest.fn()
    };

    // Mock global document
    (global as any).document = mockDocument;
  });

  afterEach(() => {
    jest.clearAllMocks();
  });

  describe('Table Header Structure', () => {
    it('should have correct number of columns in special cards table header', () => {
      // Mock table header HTML structure (after removal of Card Type column)
      const mockTableHeader = `
        <tr>
          <th>Image</th>
          <th>Name</th>
          <th>Character</th>
          <th>Card Effect</th>
        </tr>
      `;

      // Count the number of <th> elements
      const headerMatches = mockTableHeader.match(/<th>/g);
      expect(headerMatches).toHaveLength(4);
    });

    it('should not contain Card Type column in header', () => {
      const mockTableHeader = `
        <tr>
          <th>Image</th>
          <th>Name</th>
          <th>Character</th>
          <th>Card Effect</th>
        </tr>
      `;

      expect(mockTableHeader).not.toContain('Card Type');
    });
  });

  describe('Table Row Structure', () => {
    it('should have correct number of columns in special cards table rows', () => {
      // Mock table row HTML structure (after removal of Card Type column)
      const mockTableRow = `
        <tr>
          <td><img src="..." alt="Card Name"></td>
          <td><strong>Card Name</strong></td>
          <td>Character Name</td>
          <td>Card Effect Description</td>
        </tr>
      `;

      // Count the number of <td> elements
      const rowMatches = mockTableRow.match(/<td>/g);
      expect(rowMatches).toHaveLength(4);
    });

    it('should not contain card_type data in table rows', () => {
      const mockTableRow = `
        <tr>
          <td><img src="..." alt="Card Name"></td>
          <td><strong>Card Name</strong></td>
          <td>Character Name</td>
          <td>Card Effect Description</td>
        </tr>
      `;

      expect(mockTableRow).not.toContain('${card.card_type}');
      expect(mockTableRow).not.toContain('undefined');
    });
  });

  describe('Loading Message Structure', () => {
    it('should have correct colspan for loading message', () => {
      const mockLoadingRow = `
        <tr>
          <td colspan="5" class="loading">Loading special cards...</td>
        </tr>
      `;

      expect(mockLoadingRow).toContain('colspan="5"');
    });

    it('should not have colspan="6" for loading message', () => {
      const mockLoadingRow = `
        <tr>
          <td colspan="5" class="loading">Loading special cards...</td>
        </tr>
      `;

      expect(mockLoadingRow).not.toContain('colspan="6"');
    });
  });

  describe('Filter Row Structure', () => {
    it('should have correct number of filter cells', () => {
      const mockFilterRow = `
        <tr class="filter-row">
          <th><button class="clear-filters-btn">Clear All Filters</button></th>
          <th></th>
          <th></th>
          <th></th>
        </tr>
      `;

      // Count the number of <th> elements in filter row
      const filterMatches = mockFilterRow.match(/<th>/g);
      expect(filterMatches).toHaveLength(4);
    });
  });

  describe('HTML Template Validation', () => {
    it('should validate that displaySpecialCards function generates correct HTML structure', () => {
      // Mock the HTML template that would be generated by displaySpecialCards
      const mockCard = {
        id: 'test-card-id',
        name: 'Test Card',
        character: 'Test Character',
        card_effect: 'Test Effect',
        image: 'test-image.webp'
      };

      // This is the template that should be generated (without card_type)
      const expectedTemplate = `
        <td>
          <img src="/src/resources/cards/images/specials/${mockCard.image}" 
               alt="${mockCard.name}" 
               style="width: 120px; height: auto; max-height: 180px; object-fit: contain; border-radius: 5px; border: 1px solid rgba(255, 255, 255, 0.2); cursor: pointer;">
        </td>
        <td>
          <button class="add-to-deck-btn" onclick="showDeckSelection('special', '${mockCard.id}', '${mockCard.name}', this)">
            Add to Deck
          </button>
        </td>
        <td><strong>${mockCard.name}</strong></td>
        <td>${mockCard.character}</td>
        <td>${mockCard.card_effect}</td>
      `;

      // Verify the template doesn't contain card_type
      expect(expectedTemplate).not.toContain('${card.card_type}');
      expect(expectedTemplate).not.toContain('card_type');
      
      // Verify it contains the expected structure
      expect(expectedTemplate).toContain('Test Card');
      expect(expectedTemplate).toContain('Test Character');
      expect(expectedTemplate).toContain('Test Effect');
    });
  });

  describe('Column Count Consistency', () => {
    it('should have consistent column count across all table elements', () => {
      const headerColumns = 4; // Image, Name, Character, Card Effect
      const rowColumns = 4;    // Same as header
      const filterColumns = 4; // Same as header
      const loadingColspan = 5; // Includes the Add to Deck button column in index.html

      expect(headerColumns).toBe(rowColumns);
      expect(headerColumns).toBe(filterColumns);
      // Note: loadingColspan is 5 because index.html has an extra "Add to Deck" button column
    });
  });
});
