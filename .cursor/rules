# Overpower Deckbuilder Cursor Rules

## Project Overview
This is a Node.js/TypeScript deck building application for the Overpower card game with PostgreSQL database, Flyway migrations, and a web-based frontend.

## Code Style & Patterns

### TypeScript/JavaScript
- Use explicit types and interfaces
- Prefer `const` over `let` when possible
- Use template literals for string interpolation
- Use async/await over promises when possible
- Always handle errors appropriately

### File Management
- **ALWAYS fix file names to match database expectations rather than changing database data**
- When there's a mismatch between file names and database paths, rename the files to match the database
- This ensures consistency and prevents breaking existing references

### Database & Migrations
- Use Flyway migrations for all database schema changes
- Migration files should be named: `V{number}__{descriptive_name}.sql`
- Always test migrations before committing
- Use UUIDs for primary keys (not auto-incrementing integers)
- Include proper indexes for performance

### API Design
- Use RESTful endpoints with clear naming
- Include proper HTTP status codes
- Always include authentication checks for protected routes
- Use `credentials: 'include'` for fetch requests that need authentication
- Return consistent JSON response formats

### Frontend (HTML/JavaScript)
- Keep HTML semantic and accessible
- Use CSS classes for styling, avoid inline styles
- Implement proper error handling and user feedback
- Use event delegation for dynamic content
- Cache DOM queries when possible

## Project-Specific Rules

### Card Data Handling
- Card names should display apostrophes correctly (no double-escaping)
- Image paths should use the `mapImagePathToActualFile` function for consistency
- Card types: character, location, mission, event, aspect, special, power, teamwork, ally_universe, training, basic_universe, advanced_universe

### Deck Management
- Enforce game rules (e.g., max 1 location per deck)
- Validate deck composition before saving
- Provide clear user feedback for validation errors
- Auto-cleanup invalid deck states when loading

### Authentication
- Always include `credentials: 'include'` in fetch requests to authenticated endpoints
- Handle authentication failures gracefully
- Maintain session state properly

### Image Management
- Images are stored in `src/resources/cards/images/` with subdirectories by type
- Use proper image path mapping for different card types
- Include cache-busting when needed for development

## File Organization
- Keep related functionality together
- Use descriptive function and variable names
- Comment complex business logic
- Separate concerns (database, API, frontend)

## OverPower Game Sorting Rules
- **Power Type Sorting Order**: Energy ‚Üí Combat ‚Üí Brute Force ‚Üí Intelligence ‚Üí Multi-Power ‚Üí Any-Power
- Any sorting by power types should follow this exact order
- This applies to power card sections, character stat requirements, and any other power type sorting

## Testing & Debugging
- Use console.log for debugging (remove before production)
- Test all user flows thoroughly
- Verify database changes with queries
- Check browser console for errors

### üß™ MANDATORY Testing Protocol
- **üö® ALWAYS run all tests after fixing bugs or creating new features üö®**
- **This is a MANDATORY rule that must be followed at all times**
- **Before calling any bug fix or feature complete, I MUST:**
  1. Run `npm test` to execute the full test suite
  2. If any tests fail, investigate and fix the root cause
  3. Re-run tests until all pass
  4. Only then consider the work complete
- **Never mark work as done if tests are failing**
- **If tests fail due to my changes, I must fix them before proceeding**
- **Use `npm run test:watch` during development for continuous feedback**
- **Use `npm run test:coverage` to ensure adequate test coverage**

### üö´ PROHIBITED Testing Practices
- **üö® COMMENTED OUT PLACEHOLDER TESTS ARE NOT ACCEPTABLE üö®**
- **üö® IF OLD TESTS FAIL AFTER CHANGES, ASSUME YOU BROKE SOMETHING FIRST üö®**
- **üö® ONLY UPDATE TESTS SECOND - FIRST INVESTIGATE IF THE CODE IS BROKEN üö®**
- **This is a MANDATORY rule that must be followed at all times**
- **NEVER create tests that:**
  1. Are commented out with `/* */` blocks
  2. Only contain placeholder assertions like `expect(true).toBe(true)`
  3. Don't actually test any real functionality
  4. Are just empty or meaningless test stubs
- **ALL TESTS MUST:**
  1. Test actual functionality (database queries, API calls, business logic)
  2. Have meaningful assertions that verify real behavior
  3. Be uncommented and executable
  4. Provide value by catching real bugs or regressions
- **If I find placeholder tests, I MUST replace them with real tests immediately**
- **Tests that don't test anything are worse than no tests at all**

### üìä MANDATORY Test Output Reporting
- **üö® ALWAYS report test run statistics in a clear, structured format üö®**
- **This is a MANDATORY rule that must be followed at all times**
- **When running tests, I MUST always provide:**
  1. **Total tests run**: "X tests passed, Y total"
  2. **New tests added**: "Added Z new tests since last run"
  3. **Test coverage summary**: Brief description of what was tested
  4. **Any failures or issues**: Clear explanation of problems found
- **Format for test output summary:**
  ```
  ## üìä Test Results Summary
  - **Total Tests**: X passed, Y total
  - **New Tests Added**: Z tests
  - **Coverage**: [Brief description of test areas]
  - **Status**: ‚úÖ All tests passing / ‚ö†Ô∏è Issues found
  ```
- **This helps track testing progress and ensures comprehensive coverage**
- **Always highlight the number of new tests added in each test run**

## Git & Version Control
- **üö® NEVER commit or push to git without explicit user permission üö®**
- **This is a MANDATORY rule that must be followed at all times**
- **I must ALWAYS ask the user before:**
  1. Running `git add` commands
  2. Running `git commit` commands  
  3. Running `git push` commands
  4. Any other git operations that modify the repository
- **I can only suggest git commands but must wait for user approval**
- **The user has full control over when and what gets committed/pushed**
- **This rule takes precedence over all other rules**
- **Write descriptive commit messages when instructed to commit**
- **Ask for permission before any git operations**
- Test changes before committing
- Use meaningful branch names for features

## Performance
- Optimize database queries
- Minimize DOM manipulation
- Use efficient data structures
- Consider caching for frequently accessed data

## Security
- Validate all user inputs
- Use parameterized queries for database operations
- Implement proper authentication and authorization
- Sanitize data before displaying in HTML
- **üö® NEVER include passwords, API keys, session tokens, or any sensitive authentication credentials in debug statements, console.log outputs, or any other logging üö®**
- **This is a CRITICAL security rule that must be followed at all times**

## OverPower Game Rules

### Game Overview
OverPower is a card game where players control teams of legendary heroes and villains competing through battles to complete missions. Players build decks of at least 51 cards (or 56 if using Event cards) and win by either KO'ing all 4 opposing characters, completing all 7 Mission Objective cards, or having the opponent lose all their Mission Objective cards.

### Card Types

#### Character Cards
- **Team Composition**: Exactly 4 characters (3 Front Line, 1 Reserve)
- **Power Grid Values**: Range from 1-8, determine maximum Power card values each character can use
- **Threat Value**: Each character has a threat value; total team threat cannot exceed 76 (including Homebase)
- **Special Cards**: Each character has specific Special cards only they can play
- **Reserve Character**: Cannot play cards unless a card/effect allows it
- **KO Replacement**: When a Front Line Character is KO'd, Reserve moves to Front Line at start of next Draw Phase

#### Location Homebase Cards
- **Limit**: One per team, starts in play
- **Inherent Abilities**: Affect the game as described on each card
- **Threat Value**: Some have threat values that count toward team total
- **Team Total**: Character threat values + Homebase threat value ‚â§ 76

#### Power Cards
- **Types**: 6 different types (Energy, Combat, Brute Force, Intelligence, Any-Power, MultiPower)
- **Values**: Range from 1-8 for energy, 5-8 for Any-Power, 3-5 for MultiPower
- **Usage**: Characters can use Power cards ‚â§ their Power Grid Value in that type
- **Energy (Yellow Atom)**: Energy projection, rays, blasts, magic, elemental attacks
- **Combat (Red Sword/Shield)**: Direct combat, weapons, martial arts, fighting tactics
- **Brute Force (Green Rock)**: Raw strength, destructive capability, large groups
- **Intelligence (Blue Book)**: Thinking, planning, strategy, manipulation
- **Any-Power (White Circle)**: Universal attacks, no specific power type, don't contribute to Spectrum KO
- **MultiPower (Multiple Icons)**: Can act as any declared power type, wild for Spectrum KO

#### Special Cards
- **Character-Specific**: Only characters with matching names can play them
- **Copies**: Most allow multiple copies; "One Per Deck" cards limited to 1 copy
- **Actions**: Played as offensive (Crossed Swords) or defensive (Shield) actions
- **Duration Icons**:
  - Remainder of Game (Full Hourglass): Until end of game
  - Remainder of Battle (Half Hourglass): Until end of current battle
  - Attach to Character (Paperclip): Attached to character for duration
  - 1ST Icon: Can only be played as first card of turn
  - Astral Plane (Large A): Placed in special Astral Plane area

#### Universe Cards
- **Types**: Mission Objective, Event, Aspect cards
- **Mission Objectives**: 7 cards per player, win condition
- **Events**: Optional cards that affect gameplay
- **Aspects**: Additional game mechanics

### Deck Building Rules
1. **Minimum Size**: 51 cards (56 if using Event cards)
2. **Character Team**: Exactly 4 characters (3 Front Line, 1 Reserve)
3. **Threat Limit**: Total team threat value ‚â§ 76 (including Homebase)
4. **Special Cards**: Only include specials for characters in your team
5. **One Per Deck**: Special cards with this restriction limited to 1 copy
6. **Location Limit**: Maximum 1 location per deck (enforced in code)

### Game Phases
1. **Draw Phase**: Draw cards, move Reserve to Front Line if needed
2. **Events Phase**: Play Event cards
3. **Discard Phase**: Discard down to hand limit
4. **Placing Phase**: Place cards on characters
5. **Venture Phase**: Wager on Mission Objectives
6. **Battle Phase**: Attack and defend
7. **Post-concession Phase**: Handle concessions
8. **End-of-Battle Phase**: Resolve battle results

### Win Conditions
1. **KO All Opponents**: Knock out all 4 opposing characters
2. **Complete Mission**: Advance all 7 Mission Objective cards to completed pile
3. **Opponent Mission Loss**: Opponent loses all 7 Mission Objective cards (all in defeated pile)

### Game Modes

#### Constructed Play
- **Venture**: Standard mode with Mission Objectives and Events
- **Brawl**: No Mission Objectives or Events, win only by KO'ing all opponents
- **Skirmish**: Shared Mission Objectives (5, 7, or 9), highest Venture Total wins each battle

#### Limited Play
- **Draft**: 8-10 players, 3 packs, draft Character Stacks
- **Sealed Deck**: 1 Starter + 3-6 Booster packs, build from opened cards only
- **Basic Power Cards**: Always allowed in limited formats (levels 1-8)

### Technical Implementation Notes
- Deck validation must enforce all game rules
- Character power grid values must be respected for card usage
- Threat value calculations must include characters and homebase
- Special card restrictions must be enforced
- Mission Objective tracking is critical for win conditions
- Battle resolution must handle KO mechanics properly

### Advanced Game Rules (Comprehensive)

#### Universe Card Types
- **Basic Universe Cards**: Items that increase attack/defense values, require specific Power Grid levels, discarded after use, don't count toward damage or Venture Total
- **Advanced Universe Cards**: Complex equipment with unique effects, may modify attacks/defenses, can have remainder of battle/game effects
- **Training Universe Cards**: Training to increase Power card values, require Power Grid ‚â§ 5, choice between 2 Power Types, larger bonuses than Basic
- **Teamwork Universe Cards**: Coordinated multi-character attacks, require specific Power Grid level, acts as attack + requires teammate follow-up with Power card, 3rd teammate may follow up
- **Ally Universe Cards**: Sidekick/associate help, require specific Power Grid level, acts as attack + requires teammate Special card, numerically weaker than Teamwork

#### Special Card Mechanics
- **Character-Specific**: Only characters with matching names can play
- **Any Character Specials**: Can be played by any character
- **One Per Deck**: Limited to 1 copy per deck
- **Power Type/Value**: Located in top left corner for numerical attacks
- **Function Icons**:
  - Remainder of Game (Full Hourglass): Active until end of game
  - Remainder of Battle (Half Hourglass): Active until end of current battle
  - Offensive Action (Crossed Swords): Playable on your turn only
  - Defensive Action (Shield): Playable in response to opponent's attack
  - Attach to Character (Paperclip): Attached to character for duration
  - 1ST Icon: Can only be played as first card of turn
  - Astral Plane (Large A): Placed in special Astral Plane area

#### Mission and Event Cards
- **Mission Objectives**: 7 cards per player, start in Reserve Objectives Pile, win condition to complete all
- **Event Cards**: Mission-specific or Any-Mission, played during Event Phase, affect both players, only 1 per battle
- **Event Resolution**: Draw 1 card after playing, discard duplicates, place in Astral Plane if ongoing effect

#### Artifact and Homebase Cards
- **Artifact Cards**: Mystical/supernatural items, Power Grid requirements, strong long-lasting effects, don't affect Venture Total directly
- **Homebase Cards**: Team abilities active throughout game, threat level cost, 1 per team
- **Aspect Cards**: Played by Homebase, Any-Homebase or specific Homebase, 1 slot per Homebase

#### Deck Building Rules (Detailed)
- **Minimum Deck Size**: 51 cards (no Events) or 56 cards (with Events)
- **Maximum Deck Size**: No maximum, but typically 60-70 cards (rarely over 85)
- **Threat Level Limit**: 76 points total (characters + homebase + other cards)
- **Legacy Play Threat Limits** (3-stat characters):
  - 4 three-stat characters: ‚â§ 58 threat points
  - 3 three-stat characters: ‚â§ 62 threat points
  - 2 three-stat characters: ‚â§ 67 threat points
  - 1 three-stat character: ‚â§ 72 threat points
- **Power Card Distribution**: 2-3 copies of levels 3-8, 1-2 copies of levels 1-2
- **Special Card Distribution**: 1-3 copies depending on importance and strategy
- **Other Cards**: Generally 1 copy each unless specific strategy requires more

#### Game Phases (Detailed)
1. **Draw Phase**: Draw 8 cards, move Reserve to Front Line if Front Line character KO'd
2. **Event Phase**: Play Event cards, declare and resolve in initiative order
3. **Discard Phase**: Remove duplicates and unusable cards
4. **Placement Phase**: Place cards face-up on characters/homebase, build war chest
5. **Venture Phase**: Bet on Mission Objectives based on expected battle success
6. **Battle Phase**: Attack and defend with placed cards and hand
7. **Post-concession Phase**: Handle battle concessions
8. **End-of-Battle Phase**: Resolve battle results, move Objectives

#### Duplicate Card Rules
- **Power Cards**: Any Power card of equal value is duplicate regardless of type
- **Universe/Aspect/Artifact Cards**: Exact same value, requirements, and function
- **Special Cards**: Duplicate only for same character
- **Event Cards**: Multiple Events drawn = choose 1, discard others
- **Placed Cards**: Count as duplicates with hand cards
- **Unusable Cards**: Must be discarded if only usable by KO'd character, Reserve character without play ability, or Event-specified

#### Discard Pile Rules
- **Power Pack**: Usable Power cards (shuffled when Draw Pile empty)
- **Defeated Characters Pile**: Any Character Specials, used Events, defeated Characters
- **Dead Pile**: All other cards (unusable Power cards, Universe cards, character Specials, Aspects)

#### Placement Rules
- **Character Slots**: 1 Power, 1 Universe, 1 Artifact/Tactic, 1 Special per character
- **Homebase Slots**: 1 Aspect, 1 Special card per homebase
- **Reserve Characters**: Can place cards but cannot play unless effect allows
- **War Chest**: Placed cards remain until used or removed

#### Battle Mechanics
- **Initiative**: First player makes all decisions first each phase
- **Attack/Defense**: Power cards + Universe cards for bonuses
- **MultiPower/Any-Power**: Can act as any Power Type, declare when playing
- **Spectrum KO**: MultiPower cards act as any type for KO purposes
- **Cumulative KO**: Any-Power cards only count toward cumulative damage

#### Victory Conditions
1. **Complete Mission**: Move all 7 Mission Objectives to Completed pile
2. **Defeat Opponent Mission**: Move all opponent's Objectives to Defeated pile  
3. **KO All Characters**: Knock out all 4 opponent characters

#### Game Modes
- **Venture**: Standard mode with Mission Objectives and Events
- **Brawl**: No Mission Objectives/Events, win only by KO'ing all opponents
- **Skirmish**: Shared Mission Objectives (5/7/9), highest Venture Total wins each battle
- **Draft**: 8-10 players, 3 packs, draft Character Stacks
- **Sealed Deck**: 1 Starter + 3-6 Booster packs, build from opened cards only

#### Text Display Rules
- **NEVER truncate text with "..." unless explicitly requested by the user**
- **Always display full text content with proper wrapping**
- **Use CSS text wrapping to ensure all content is visible**
- **Text should wrap within cells/containers rather than being cut off**

## üöÄ MANDATORY Deployment Protocol

### üö® DEPLOYMENT WORKFLOW RULES üö®
- **This is a MANDATORY rule that must be followed at all times**
- **I must ALWAYS follow this exact sequence for any deployment:**

#### 1. Pre-Deployment Validation
- **ALWAYS run `npm test` and ensure ALL tests pass (95/95)**
- **ALWAYS run `npm run build` to verify TypeScript compilation**
- **NEVER deploy with failing tests or build errors**
- **If tests fail, I MUST fix them before proceeding with deployment**

#### 2. Docker Image Build Process
- **ALWAYS use `docker buildx build --platform linux/amd64 --no-cache` for production builds**
- **ALWAYS tag images as `overpower-deckbuilder:latest` locally first**
- **ALWAYS verify the image builds successfully before pushing**

#### 3. ECR Authentication & Push
- **ALWAYS get ECR URL from Terraform: `cd infra/ && terraform output -raw ecr_repository_url`**
- **ALWAYS login to ECR: `aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin $ECR_URL`**
- **ALWAYS tag for ECR: `docker tag overpower-deckbuilder:latest $ECR_URL:latest`**
- **ALWAYS push to ECR: `docker push $ECR_URL:latest`**

#### 4. EC2 Deployment Process
- **ALWAYS get instance ID: `cd infra/ && terraform output -raw ecr_repository_url`**
- **ALWAYS use SSM to deploy: `aws ssm send-command --region us-west-2 --instance-ids $INSTANCE_ID`**
- **ALWAYS include these commands in the SSM deployment:**
  1. `docker stop overpower-app || true`
  2. `docker rm overpower-app || true`
  3. `docker pull $ECR_URL:latest`
  4. `docker run -d --name overpower-app --restart unless-stopped -p 3000:3000 -e NODE_ENV=production -e DATABASE_URL="$(aws ssm get-parameter --name "/op-deckbuilder/dev/database/url" --with-decryption --region us-west-2 --query "Parameter.Value" --output text)" -e NODE_TLS_REJECT_UNAUTHORIZED=0 -e PORT=3000 $ECR_URL:latest`
  5. `sleep 20`
  6. `docker ps | grep overpower-app`
  7. `docker logs overpower-app --tail 10`

#### 5. Post-Deployment Verification
- **ALWAYS verify deployment success by checking SSM command output**
- **ALWAYS test application accessibility: `curl -I http://excelsior.cards`**
- **ALWAYS check container logs for any errors**
- **ALWAYS confirm HTTP 200 response from the application**

### üö´ PROHIBITED Deployment Practices
- **NEVER deploy without running tests first**
- **NEVER deploy with build errors or TypeScript compilation failures**
- **NEVER use cached Docker builds for production (`--no-cache` is mandatory)**
- **NEVER build for wrong architecture (must be `linux/amd64`)**
- **NEVER skip ECR authentication before pushing**
- **NEVER deploy without proper environment variables**
- **NEVER skip post-deployment verification**

### üîß Deployment Environment Variables
- **NODE_ENV**: Always `production` for deployments
- **DATABASE_URL**: Always retrieved from SSM Parameter Store
- **PORT**: Always `3000`
- **NODE_TLS_REJECT_UNAUTHORIZED**: Always `0` (for development)

### üìã Required AWS Resources
- **ECR Repository**: `overpower-deckbuilder` in `us-west-2`
- **EC2 Instance**: `i-0dee560af076c0f9d` (or get from Terraform output)
- **RDS Database**: PostgreSQL instance with proper security groups
- **SSM Parameters**: All database and app configuration stored in Parameter Store
- **Route 53**: Domain configuration for `excelsior.cards`

### üö® Emergency Deployment Commands
If standard deployment fails, use these commands in order:

1. **Check EC2 status:**
   ```bash
   aws ec2 describe-instances --instance-ids $INSTANCE_ID --region us-west-2
   ```

2. **Check container status:**
   ```bash
   aws ssm send-command --region us-west-2 --instance-ids $INSTANCE_ID --document-name "AWS-RunShellScript" --parameters 'commands=["docker ps -a"]'
   ```

3. **Check application logs:**
   ```bash
   aws ssm send-command --region us-west-2 --instance-ids $INSTANCE_ID --document-name "AWS-RunShellScript" --parameters 'commands=["docker logs overpower-app --tail 50"]'
   ```

4. **Restart application:**
   ```bash
   aws ssm send-command --region us-west-2 --instance-ids $INSTANCE_ID --document-name "AWS-RunShellScript" --parameters 'commands=["docker restart overpower-app"]'
   ```

### üìä Deployment Success Criteria
- **All tests pass (95/95)**
- **Docker image builds successfully for AMD64**
- **Image pushes to ECR without errors**
- **SSM deployment command returns success status**
- **Container runs and shows "Up" status**
- **Application responds with HTTP 200**
- **No error logs in container output**

### üîÑ Rollback Procedure
If deployment fails:
1. **Stop current container: `docker stop overpower-app`**
2. **Remove failed container: `docker rm overpower-app`**
3. **Pull previous working image: `docker pull $ECR_URL:previous-tag`**
4. **Run previous version: `docker run -d --name overpower-app [previous-command]`**
5. **Verify rollback success**

### üìù Deployment Checklist
Before any deployment, I must verify:
- [ ] All tests pass (`npm test`)
- [ ] Build succeeds (`npm run build`)
- [ ] Docker image builds for AMD64
- [ ] ECR authentication successful
- [ ] Image pushed to ECR
- [ ] SSM deployment command sent
- [ ] Container running successfully
- [ ] Application accessible via HTTP
- [ ] No critical errors in logs
