# Overpower Deckbuilder Cursor Rules

## Project Overview
This is a Node.js/TypeScript deck building application for the Overpower card game with PostgreSQL database, Flyway migrations, and a web-based frontend.

## Code Style & Patterns

### TypeScript/JavaScript
- Use explicit types and interfaces
- Prefer `const` over `let` when possible
- Use template literals for string interpolation
- Use async/await over promises when possible
- Always handle errors appropriately

### File Management
- **ALWAYS fix file names to match database expectations rather than changing database data**
- When there's a mismatch between file names and database paths, rename the files to match the database
- This ensures consistency and prevents breaking existing references

### Database & Migrations
- Use Flyway migrations for all database schema changes
- Migration files should be named: `V{number}__{descriptive_name}.sql`
- Always test migrations before committing
- Use UUIDs for primary keys (not auto-incrementing integers)
- Include proper indexes for performance

### API Design
- Use RESTful endpoints with clear naming
- Include proper HTTP status codes
- Always include authentication checks for protected routes
- Use `credentials: 'include'` for fetch requests that need authentication
- Return consistent JSON response formats

### Frontend (HTML/JavaScript)
- Keep HTML semantic and accessible
- Use CSS classes for styling, avoid inline styles
- Implement proper error handling and user feedback
- Use event delegation for dynamic content
- Cache DOM queries when possible

## Project-Specific Rules

### Card Data Handling
- Card names should display apostrophes correctly (no double-escaping)
- Image paths should use the `mapImagePathToActualFile` function for consistency
- Card types: character, location, mission, event, aspect, special, power, teamwork, ally_universe, training, basic_universe, advanced_universe

### Deck Management
- Enforce game rules (e.g., max 1 location per deck)
- Validate deck composition before saving
- Provide clear user feedback for validation errors
- Auto-cleanup invalid deck states when loading

### Authentication
- Always include `credentials: 'include'` in fetch requests to authenticated endpoints
- Handle authentication failures gracefully
- Maintain session state properly

### Image Management
- Images are stored in `src/resources/cards/images/` with subdirectories by type
- Use proper image path mapping for different card types
- Include cache-busting when needed for development

## File Organization
- Keep related functionality together
- Use descriptive function and variable names
- Comment complex business logic
- Separate concerns (database, API, frontend)

## OverPower Game Sorting Rules
- **Power Type Sorting Order**: Energy â†’ Combat â†’ Brute Force â†’ Intelligence â†’ Multi-Power â†’ Any-Power
- Any sorting by power types should follow this exact order
- This applies to power card sections, character stat requirements, and any other power type sorting

## Testing & Debugging
- Use console.log for debugging (remove before production)
- Test all user flows thoroughly
- Verify database changes with queries
- Check browser console for errors

if## Git Workflow - CRITICAL RULE
- **ðŸš¨ NEVER COMMIT OR PUSH TO GIT WITHOUT EXPLICIT USER INSTRUCTION ðŸš¨**
- **This is a MANDATORY rule that must be followed at all times**
- **Even if I think changes are ready, I must wait for explicit "commit and push" instruction**
- **Write descriptive commit messages when instructed to commit**
- **Ask for permission before any git operations**
- Test changes before committing
- Use meaningful branch names for features

## Performance
- Optimize database queries
- Minimize DOM manipulation
- Use efficient data structures
- Consider caching for frequently accessed data

## Security
- Validate all user inputs
- Use parameterized queries for database operations
- Implement proper authentication and authorization
- Sanitize data before displaying in HTML
- **ðŸš¨ NEVER include passwords, API keys, session tokens, or any sensitive authentication credentials in debug statements, console.log outputs, or any other logging ðŸš¨**
- **This is a CRITICAL security rule that must be followed at all times**

## OverPower Game Rules

### Game Overview
OverPower is a card game where players control teams of legendary heroes and villains competing through battles to complete missions. Players build decks of at least 51 cards (or 56 if using Event cards) and win by either KO'ing all 4 opposing characters, completing all 7 Mission Objective cards, or having the opponent lose all their Mission Objective cards.

### Card Types

#### Character Cards
- **Team Composition**: Exactly 4 characters (3 Front Line, 1 Reserve)
- **Power Grid Values**: Range from 1-8, determine maximum Power card values each character can use
- **Threat Value**: Each character has a threat value; total team threat cannot exceed 76 (including Homebase)
- **Special Cards**: Each character has specific Special cards only they can play
- **Reserve Character**: Cannot play cards unless a card/effect allows it
- **KO Replacement**: When a Front Line Character is KO'd, Reserve moves to Front Line at start of next Draw Phase

#### Location Homebase Cards
- **Limit**: One per team, starts in play
- **Inherent Abilities**: Affect the game as described on each card
- **Threat Value**: Some have threat values that count toward team total
- **Team Total**: Character threat values + Homebase threat value â‰¤ 76

#### Power Cards
- **Types**: 6 different types (Energy, Combat, Brute Force, Intelligence, Any-Power, MultiPower)
- **Values**: Range from 1-8 for energy, 5-8 for Any-Power, 3-5 for MultiPower
- **Usage**: Characters can use Power cards â‰¤ their Power Grid Value in that type
- **Energy (Yellow Atom)**: Energy projection, rays, blasts, magic, elemental attacks
- **Combat (Red Sword/Shield)**: Direct combat, weapons, martial arts, fighting tactics
- **Brute Force (Green Rock)**: Raw strength, destructive capability, large groups
- **Intelligence (Blue Book)**: Thinking, planning, strategy, manipulation
- **Any-Power (White Circle)**: Universal attacks, no specific power type, don't contribute to Spectrum KO
- **MultiPower (Multiple Icons)**: Can act as any declared power type, wild for Spectrum KO

#### Special Cards
- **Character-Specific**: Only characters with matching names can play them
- **Copies**: Most allow multiple copies; "One Per Deck" cards limited to 1 copy
- **Actions**: Played as offensive (Crossed Swords) or defensive (Shield) actions
- **Duration Icons**:
  - Remainder of Game (Full Hourglass): Until end of game
  - Remainder of Battle (Half Hourglass): Until end of current battle
  - Attach to Character (Paperclip): Attached to character for duration
  - 1ST Icon: Can only be played as first card of turn
  - Astral Plane (Large A): Placed in special Astral Plane area

#### Universe Cards
- **Types**: Mission Objective, Event, Aspect cards
- **Mission Objectives**: 7 cards per player, win condition
- **Events**: Optional cards that affect gameplay
- **Aspects**: Additional game mechanics

### Deck Building Rules
1. **Minimum Size**: 51 cards (56 if using Event cards)
2. **Character Team**: Exactly 4 characters (3 Front Line, 1 Reserve)
3. **Threat Limit**: Total team threat value â‰¤ 76 (including Homebase)
4. **Special Cards**: Only include specials for characters in your team
5. **One Per Deck**: Special cards with this restriction limited to 1 copy
6. **Location Limit**: Maximum 1 location per deck (enforced in code)

### Game Phases
1. **Draw Phase**: Draw cards, move Reserve to Front Line if needed
2. **Events Phase**: Play Event cards
3. **Discard Phase**: Discard down to hand limit
4. **Placing Phase**: Place cards on characters
5. **Venture Phase**: Wager on Mission Objectives
6. **Battle Phase**: Attack and defend
7. **Post-concession Phase**: Handle concessions
8. **End-of-Battle Phase**: Resolve battle results

### Win Conditions
1. **KO All Opponents**: Knock out all 4 opposing characters
2. **Complete Mission**: Advance all 7 Mission Objective cards to completed pile
3. **Opponent Mission Loss**: Opponent loses all 7 Mission Objective cards (all in defeated pile)

### Game Modes

#### Constructed Play
- **Venture**: Standard mode with Mission Objectives and Events
- **Brawl**: No Mission Objectives or Events, win only by KO'ing all opponents
- **Skirmish**: Shared Mission Objectives (5, 7, or 9), highest Venture Total wins each battle

#### Limited Play
- **Draft**: 8-10 players, 3 packs, draft Character Stacks
- **Sealed Deck**: 1 Starter + 3-6 Booster packs, build from opened cards only
- **Basic Power Cards**: Always allowed in limited formats (levels 1-8)

### Technical Implementation Notes
- Deck validation must enforce all game rules
- Character power grid values must be respected for card usage
- Threat value calculations must include characters and homebase
- Special card restrictions must be enforced
- Mission Objective tracking is critical for win conditions
- Battle resolution must handle KO mechanics properly

### Advanced Game Rules (Comprehensive)

#### Universe Card Types
- **Basic Universe Cards**: Items that increase attack/defense values, require specific Power Grid levels, discarded after use, don't count toward damage or Venture Total
- **Advanced Universe Cards**: Complex equipment with unique effects, may modify attacks/defenses, can have remainder of battle/game effects
- **Training Universe Cards**: Training to increase Power card values, require Power Grid â‰¤ 5, choice between 2 Power Types, larger bonuses than Basic
- **Teamwork Universe Cards**: Coordinated multi-character attacks, require specific Power Grid level, acts as attack + requires teammate follow-up with Power card, 3rd teammate may follow up
- **Ally Universe Cards**: Sidekick/associate help, require specific Power Grid level, acts as attack + requires teammate Special card, numerically weaker than Teamwork

#### Special Card Mechanics
- **Character-Specific**: Only characters with matching names can play
- **Any Character Specials**: Can be played by any character
- **One Per Deck**: Limited to 1 copy per deck
- **Power Type/Value**: Located in top left corner for numerical attacks
- **Function Icons**:
  - Remainder of Game (Full Hourglass): Active until end of game
  - Remainder of Battle (Half Hourglass): Active until end of current battle
  - Offensive Action (Crossed Swords): Playable on your turn only
  - Defensive Action (Shield): Playable in response to opponent's attack
  - Attach to Character (Paperclip): Attached to character for duration
  - 1ST Icon: Can only be played as first card of turn
  - Astral Plane (Large A): Placed in special Astral Plane area

#### Mission and Event Cards
- **Mission Objectives**: 7 cards per player, start in Reserve Objectives Pile, win condition to complete all
- **Event Cards**: Mission-specific or Any-Mission, played during Event Phase, affect both players, only 1 per battle
- **Event Resolution**: Draw 1 card after playing, discard duplicates, place in Astral Plane if ongoing effect

#### Artifact and Homebase Cards
- **Artifact Cards**: Mystical/supernatural items, Power Grid requirements, strong long-lasting effects, don't affect Venture Total directly
- **Homebase Cards**: Team abilities active throughout game, threat level cost, 1 per team
- **Aspect Cards**: Played by Homebase, Any-Homebase or specific Homebase, 1 slot per Homebase

#### Deck Building Rules (Detailed)
- **Minimum Deck Size**: 51 cards (no Events) or 56 cards (with Events)
- **Maximum Deck Size**: No maximum, but typically 60-70 cards (rarely over 85)
- **Threat Level Limit**: 76 points total (characters + homebase + other cards)
- **Legacy Play Threat Limits** (3-stat characters):
  - 4 three-stat characters: â‰¤ 58 threat points
  - 3 three-stat characters: â‰¤ 62 threat points
  - 2 three-stat characters: â‰¤ 67 threat points
  - 1 three-stat character: â‰¤ 72 threat points
- **Power Card Distribution**: 2-3 copies of levels 3-8, 1-2 copies of levels 1-2
- **Special Card Distribution**: 1-3 copies depending on importance and strategy
- **Other Cards**: Generally 1 copy each unless specific strategy requires more

#### Game Phases (Detailed)
1. **Draw Phase**: Draw 8 cards, move Reserve to Front Line if Front Line character KO'd
2. **Event Phase**: Play Event cards, declare and resolve in initiative order
3. **Discard Phase**: Remove duplicates and unusable cards
4. **Placement Phase**: Place cards face-up on characters/homebase, build war chest
5. **Venture Phase**: Bet on Mission Objectives based on expected battle success
6. **Battle Phase**: Attack and defend with placed cards and hand
7. **Post-concession Phase**: Handle battle concessions
8. **End-of-Battle Phase**: Resolve battle results, move Objectives

#### Duplicate Card Rules
- **Power Cards**: Any Power card of equal value is duplicate regardless of type
- **Universe/Aspect/Artifact Cards**: Exact same value, requirements, and function
- **Special Cards**: Duplicate only for same character
- **Event Cards**: Multiple Events drawn = choose 1, discard others
- **Placed Cards**: Count as duplicates with hand cards
- **Unusable Cards**: Must be discarded if only usable by KO'd character, Reserve character without play ability, or Event-specified

#### Discard Pile Rules
- **Power Pack**: Usable Power cards (shuffled when Draw Pile empty)
- **Defeated Characters Pile**: Any Character Specials, used Events, defeated Characters
- **Dead Pile**: All other cards (unusable Power cards, Universe cards, character Specials, Aspects)

#### Placement Rules
- **Character Slots**: 1 Power, 1 Universe, 1 Artifact/Tactic, 1 Special per character
- **Homebase Slots**: 1 Aspect, 1 Special card per homebase
- **Reserve Characters**: Can place cards but cannot play unless effect allows
- **War Chest**: Placed cards remain until used or removed

#### Battle Mechanics
- **Initiative**: First player makes all decisions first each phase
- **Attack/Defense**: Power cards + Universe cards for bonuses
- **MultiPower/Any-Power**: Can act as any Power Type, declare when playing
- **Spectrum KO**: MultiPower cards act as any type for KO purposes
- **Cumulative KO**: Any-Power cards only count toward cumulative damage

#### Victory Conditions
1. **Complete Mission**: Move all 7 Mission Objectives to Completed pile
2. **Defeat Opponent Mission**: Move all opponent's Objectives to Defeated pile  
3. **KO All Characters**: Knock out all 4 opponent characters

#### Game Modes
- **Venture**: Standard mode with Mission Objectives and Events
- **Brawl**: No Mission Objectives/Events, win only by KO'ing all opponents
- **Skirmish**: Shared Mission Objectives (5/7/9), highest Venture Total wins each battle
- **Draft**: 8-10 players, 3 packs, draft Character Stacks
- **Sealed Deck**: 1 Starter + 3-6 Booster packs, build from opened cards only

#### Text Display Rules
- **NEVER truncate text with "..." unless explicitly requested by the user**
- **Always display full text content with proper wrapping**
- **Use CSS text wrapping to ensure all content is visible**
- **Text should wrap within cells/containers rather than being cut off**
